name: Manual Kernel Build (ARM 32-bit)

on:
  # This enables the manual trigger button
  workflow_dispatch:
    inputs:
      defconfig_name:
        description: 'Name of the defconfig file (inside arch/arm/configs/)'
        required: true
        # Replace this default with your actual config name if different
        default: 'x653c_defconfig' 

jobs:
  build-kernel:
    runs-on: ubuntu-22.04

    steps:
    # 1. Clone the repository
    - name: Checkout Source Code
      uses: actions/checkout@v4
      with:
        repository: monkey-d/inifnix-smart-4_x653c-kernel-source
        path: kernel_source

    # 2. Install dependencies required for Kernel 4.9 on Ubuntu 22.04
    - name: Install Build Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib gcc-multilib \
          git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev \
           python3
        
    

    # 3. Download and Setup GCC Linaro 4.9 Toolchain
    - name: Setup Linaro GCC 4.9 (ARM-EABI)
      run: |
        mkdir -p $GITHUB_WORKSPACE/toolchain
        cd $GITHUB_WORKSPACE/toolchain
        
        echo "Downloading Toolchain..."
        wget -q https://releases.linaro.org/components/toolchain/binaries/4.9-2017.01/arm-eabi/gcc-linaro-4.9.4-2017.01-x86_64_arm-eabi.tar.xz
        
        echo "Extracting Toolchain..."
        tar -xf gcc-linaro-4.9.4-2017.01-x86_64_arm-eabi.tar.xz
        
        # Add toolchain bin to GITHUB_PATH so following steps can use it
        echo "$GITHUB_WORKSPACE/toolchain/gcc-linaro-4.9.4-2017.01-x86_64_arm-eabi/bin" >> $GITHUB_PATH

    # 4. Compile the Kernel
    - name: Build zImage-dtb
      working-directory: kernel_source
      env:
        ARCH: arm
        CROSS_COMPILE: arm-eabi-
      run: |
        echo "Verifying GCC Version..."
        arm-eabi-gcc --version
        
        echo "Cleaning build tree..."
        make clean && make mrproper
        
        echo "Applying defconfig: ${{ github.event.inputs.defconfig_name }}..."
        make ${{ github.event.inputs.defconfig_name }}
        
        echo "Starting Build..."
        # -j$(nproc) uses all available CPU cores
        make -j$(nproc --all) zImage-dtb

    # 5. Verify the file exists before uploading
    - name: Check Output
      working-directory: kernel_source
      run: |
        if [ -f "arch/arm/boot/zImage-dtb" ]; then
          echo "Build Success! zImage-dtb found."
          ls -lh arch/arm/boot/zImage-dtb
        else
          echo "Error: zImage-dtb not found!"
          exit 1
        fi

    # 6. Upload the result
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: zImage-dtb
        path: kernel_source/arch/arm/boot/zImage-dtb
