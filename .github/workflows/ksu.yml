name: Integrate KernelSU

on:
  workflow_dispatch: # Allows you to manually trigger this workflow from the Actions tab

jobs:
  integrate:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push commits back to the repo

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for proper git history modification

      - name: Run KernelSU Setup Script
        run: |
          # Runs the official KernelSU integration script
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

      - name: Update Defconfig
        run: |
          DEFCONFIG_PATH="arch/arm/configs/x653c_defconfig"
          
          if [ -f "$DEFCONFIG_PATH" ]; then
            echo "Found defconfig at $DEFCONFIG_PATH"
            # specific config for KernelSU
            if ! grep -q "CONFIG_KSU=y" "$DEFCONFIG_PATH"; then
              echo "" >> "$DEFCONFIG_PATH"
              echo "CONFIG_KSU=y" >> "$DEFCONFIG_PATH"
              # Optional: Ensure Kprobes is enabled if your kernel supports it
              echo "CONFIG_KPROBES=y" >> "$DEFCONFIG_PATH"
              echo "CONFIG_HAVE_KPROBES=y" >> "$DEFCONFIG_PATH"
              echo "CONFIG_KPROBE_EVENTS=y" >> "$DEFCONFIG_PATH"
              echo "Updated $DEFCONFIG_PATH with KernelSU configs."
            else
              echo "KernelSU already enabled in defconfig."
            fi
          else
            echo "::error::Defconfig file not found at $DEFCONFIG_PATH"
            exit 1
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Add the new KernelSU directory (likely a submodule) and modified files
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: integrate KernelSU and update defconfig"
            git push
          fi
